@model List<EventRegistration>

@{
    ViewData["Title"] = "Reports";
    Layout = "~/Views/Shared/_Staff.cshtml";
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Reports</h3>
        <button class="btn btn-success" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Export to Excel
        </button>
    </div>

    <div class="mb-3 d-flex align-items-end justify-content-between">
        <div class="d-flex gap-2">
            <div>
                <label for="roleFilter" class="form-label">Role:</label>
                <select class="form-select" id="roleFilter" onchange="filterTable()">
                    <option value="">All Roles</option>
                    @foreach (var role in Model.Select(r => r.Role).Distinct())
                    {
                        <option value="@role">@role</option>
                    }
                </select>
            </div>

            <div>
                <label class="pl-3" for="eventFilter" class="form-label">Event:</label>
                <select class="form-select" id="eventFilter" onchange="filterTable()">
                    <option value="">All Events</option>
                    @foreach (var ev in Model.Select(r => r.EventName).Distinct())
                    {
                        <option value="@ev">@ev</option>
                    }
                </select>
            </div>
        </div>

        <div>
            <a href="@Url.Action("Reports", "Staff")" class="btn btn-secondary mt-4">Reset</a>
        </div>
    </div>


    <table class="table table-bordered table-striped" id="firebaseTable">
        <thead class="thead-dark">
            <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Event Name</th>
                <th>Role</th>
                <th>Payment Amount</th>
                <th>Payment Status</th>
                <th>Registration Date</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in Model)
            {
                <tr>
                    <td>@r.FullName</td>
                    <td>@r.Email</td>
                    <td>@r.EventName</td>
                    <td>@r.Role</td>
                    <td>$@r.PaymentAmount</td>
                    <td>@r.PaymentStatus</td>
                    <td>@r.RegistrationDate.ToDateTime().ToLocalTime()</td>
                </tr>
            }
        </tbody>
    </table>

</div>

@section Scripts {

    <!-- SheetJS (Excel export) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        function filterTable() {
            var role = document.getElementById("roleFilter").value.toLowerCase();
            var eventName = document.getElementById("eventFilter").value.toLowerCase();
            var rows = document.querySelectorAll("#firebaseTable tbody tr");

            rows.forEach(function(row) {
                var rowRole = row.cells[3].innerText.toLowerCase();      // Role column
                var rowEvent = row.cells[2].innerText.toLowerCase();     // EventName column

                if ((role === "" || rowRole === role) &&
                    (eventName === "" || rowEvent === eventName)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        // Export to Excel
        function exportToExcel() {
            var table = document.getElementById("firebaseTable");
            var workbook = XLSX.utils.table_to_book(table, { sheet: "Report" });
            XLSX.writeFile(workbook, "Reports.xlsx");
        }
    </script>
}
