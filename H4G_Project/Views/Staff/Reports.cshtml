@model List<H4G_Project.Models.EventRegistration>

@{
    ViewData["Title"] = "Reports";
    Layout = "~/Views/Shared/_Staff.cshtml";
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Reports</h3>
        <button class="btn btn-success" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Export to Excel
        </button>
    </div>

    <div class="mb-3 d-flex align-items-end justify-content-between">
        <div class="d-flex gap-2">
            <div>
                <label for="roleFilter" class="form-label">Role:</label>
                <select class="form-select" id="roleFilter" onchange="filterTable()">
                    <option value="">All Roles</option>
                    @foreach (var role in Model.Select(r => r.Role).Distinct())
                    {
                        <option value="@role">@role</option>
                    }
                </select>
            </div>

            <div>
                <label for="eventFilter" class="form-label">Event:</label>
                <select class="form-select" id="eventFilter" onchange="filterTable()">
                    <option value="">All Events</option>
                    @foreach (var ev in Model.Select(r => r.EventName).Distinct())
                    {
                        <option value="@ev">@ev</option>
                    }
                </select>
            </div>
        </div>

        <div>
            <a href="@Url.Action("Reports", "Staff")" class="btn btn-secondary mt-4">Reset</a>
        </div>
    </div>

    <table class="table table-bordered table-striped" id="firebaseTable">
        <thead class="thead-dark">
            <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Event Name</th>
                <th>Role</th>
                <th>Payment Amount</th>
                <th>Payment Status</th>
                <th>Registration Date</th>
                <th>Waitlist Status</th>
                <th>Attendance</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in Model)
            {
                <tr>
                    <td>@r.FullName</td>
                    <td>@r.Email</td>
                    <td>@r.EventName</td>
                    <td>@r.Role</td>
                    <td>$@r.PaymentAmount</td>

                    <!-- Payment badge -->
                    <td>
                        @if (r.PaymentStatus == "Completed")
                        {
                            <span class="badge bg-success">Completed</span>
                        }
                        else if (r.PaymentStatus == "Pending")
                        {
                            <span class="badge bg-warning text-dark">Pending</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@r.PaymentStatus</span>
                        }
                    </td>

                    <td>@r.RegistrationDate.ToDateTime().ToLocalTime()</td>

                    <!-- Waitlist badge -->
                    <td>
                        @if (r.WaitlistStatus == "Confirmed")
                        {
                            <span class="badge bg-success">Confirmed</span>
                        }
                        else if (r.WaitlistStatus == "Waitlisted")
                        {
                            <span class="badge bg-danger">Waitlisted</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">-</span>
                        }
                    </td>
                    <td>
                        @if (r.Attendance)
                        {
                            <span class="badge bg-success">Attended</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Not Attended</span>
                        }
                    </td>
                </tr>

            }
        </tbody>
    </table>

</div>

@section Scripts {
    <!-- SheetJS (Excel export) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        function filterTable() {
            var role = document.getElementById("roleFilter").value.toLowerCase();
            var eventName = document.getElementById("eventFilter").value.toLowerCase();
            var rows = document.querySelectorAll("#firebaseTable tbody tr");

            rows.forEach(function(row) {
                var rowRole = row.cells[3].innerText.toLowerCase();      // Role column
                var rowEvent = row.cells[2].innerText.toLowerCase();     // EventName column

                if ((role === "" || rowRole === role) &&
                    (eventName === "" || rowEvent === eventName)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        function exportToExcel() {
            var table = document.getElementById("firebaseTable");
            var rows = Array.from(table.querySelectorAll("tbody tr"));

            var confirmedRows = [];
            var waitlistedRows = [];
            var volunteerRows = [];

            rows.forEach(row => {
                var waitlistStatus = row.cells[7].innerText.trim(); // Waitlist Status column
                var role = row.cells[3].innerText.trim();           // Role column

                if (role.toLowerCase() === "volunteer") {
                    volunteerRows.push(row);
                } else if (waitlistStatus === "Confirmed") {
                    confirmedRows.push(row);
                } else if (waitlistStatus === "Waitlisted") {
                    waitlistedRows.push(row);
                }
            });

            function rowsToSheet(rowsArray) {
                var data = [];
                // Header
                var headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText);
                data.push(headers);

                rowsArray.forEach(row => {
                    var rowData = Array.from(row.cells).map(td => td.innerText);
                    data.push(rowData);
                });

                return XLSX.utils.aoa_to_sheet(data);
            }

            var wb = XLSX.utils.book_new();

            // Just append sheets with names directly
            XLSX.utils.book_append_sheet(wb, rowsToSheet(confirmedRows), "Confirmed");
            XLSX.utils.book_append_sheet(wb, rowsToSheet(waitlistedRows), "Waitlisted");
            XLSX.utils.book_append_sheet(wb, rowsToSheet(volunteerRows), "Volunteers");

            XLSX.writeFile(wb, "Reports.xlsx");
        }


    </script>
}
