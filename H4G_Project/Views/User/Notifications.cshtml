@{
    ViewData["Title"] = "Notifications";
    Layout = "~/Views/Shared/_Member.cshtml";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Your Notifications</h2>
                <button class="btn btn-sm btn-outline-primary" onclick="markAllAsRead()">
                    Mark All as Read
                </button>
            </div>

            <div id="notificationsList">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading notifications...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.notification-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    background-color: #fff;
    transition: all 0.2s ease;
}

.notification-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.notification-item.unread {
    border-left: 4px solid #007bff;
    background-color: #f8f9fa;
}

.notification-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.notification-message {
    color: #666;
    margin-bottom: 8px;
}

.notification-meta {
    font-size: 0.85em;
    color: #999;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-time {
    font-style: italic;
}

.mark-read-btn {
    font-size: 0.8em;
    padding: 2px 8px;
}

.no-notifications {
    text-align: center;
    padding: 40px;
    color: #666;
}
</style>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
});

async function loadNotifications() {
    try {
        const response = await fetch('/User/GetNotifications');
        const notifications = await response.json();
        
        displayNotifications(notifications);
    } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notificationsList').innerHTML = 
            '<div class="alert alert-danger">Error loading notifications</div>';
    }
}

function displayNotifications(notifications) {
    const container = document.getElementById('notificationsList');
    
    console.log('Displaying notifications:', notifications);
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="no-notifications">
                <i class="fas fa-bell-slash fa-3x mb-3"></i>
                <h4>No notifications yet</h4>
                <p>You'll see notifications here when staff post comments on events you're registered for.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    notifications.forEach((notification, index) => {
        console.log(`Notification ${index}:`, notification);
        console.log(`CreatedAt for notification ${index}:`, notification.createdAt);
        
        const isUnread = !notification.isRead;
        const timeAgo = getTimeAgo(notification.createdAtMs || notification.createdAt);
        
        html += `
            <div class="notification-item ${isUnread ? 'unread' : ''}" data-id="${notification.id}">
                <div class="notification-title">${notification.title}</div>
                <div class="notification-message">${notification.message}</div>
                <div class="notification-meta">
                    <span class="notification-time">${timeAgo}</span>
                    ${isUnread ? `<button class="btn btn-sm btn-outline-primary mark-read-btn" onclick="markAsRead('${notification.id}')">Mark as Read</button>` : '<span class="text-muted">Read</span>'}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

async function markAsRead(notificationId) {
    try {
        const response = await fetch('/User/MarkNotificationRead', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `notificationId=${notificationId}`
        });
        
        const result = await response.json();
        if (result.success) {
            // Update the UI
            const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
            notificationElement.classList.remove('unread');
            notificationElement.querySelector('.notification-meta').innerHTML = 
                notificationElement.querySelector('.notification-meta').innerHTML.replace(
                    /<button.*?<\/button>/, '<span class="text-muted">Read</span>'
                );
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

async function markAllAsRead() {
    try {
        const response = await fetch('/User/MarkAllNotificationsRead', {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            // Reload notifications
            loadNotifications();
        }
    } catch (error) {
        console.error('Error marking all notifications as read:', error);
    }
}

function getTimeAgo(timestamp) {
    console.log('Timestamp received:', timestamp, 'Type:', typeof timestamp);
    
    const now = new Date();
    let notificationTime;
    
    // Handle the new createdAtMs format (milliseconds since epoch)
    if (typeof timestamp === 'number' && timestamp > 0) {
        console.log('Using timestamp as milliseconds:', timestamp);
        notificationTime = new Date(timestamp);
    }
    // Handle ISO string format
    else if (typeof timestamp === 'string') {
        console.log('Using string timestamp:', timestamp);
        notificationTime = new Date(timestamp);
    }
    // Handle Firestore Timestamp object (fallback)
    else if (timestamp && timestamp.seconds) {
        console.log('Using timestamp.seconds:', timestamp.seconds);
        notificationTime = new Date(timestamp.seconds * 1000);
    }
    // If timestamp is null, undefined, or empty object, return a default
    else if (!timestamp || (typeof timestamp === 'object' && Object.keys(timestamp).length === 0)) {
        console.log('No valid timestamp, returning default');
        return 'Recently';
    }
    else {
        console.log('Unknown timestamp format:', timestamp);
        return 'Recently';
    }
    
    console.log('Parsed notification time:', notificationTime);
    
    const diffInSeconds = Math.floor((now - notificationTime) / 1000);
    
    if (isNaN(diffInSeconds) || diffInSeconds < 0) {
        return 'Just now';
    }
    
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
    return `${Math.floor(diffInSeconds / 86400)} days ago`;
}
</script>
}