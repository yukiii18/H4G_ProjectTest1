@{
    ViewData["Title"] = "User Calendar";
    Layout = "~/Views/Shared/_Member.cshtml";
    var successMessage = TempData["SuccessMessage"] as string;
}

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />

<!-- SweetAlert CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.6/dist/sweetalert2.min.css" rel="stylesheet" />

<div class="container mt-4">
    <h3 class="mb-3">Event Calendar</h3>
    <div id="calendar"></div>
</div>

@section Scripts {

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <!-- SweetAlert JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.6/dist/sweetalert2.all.min.js"></script>

    <!-- Anti-forgery token (important for POST) -->
    @Html.AntiForgeryToken()

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',

                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },

                events: '/Calendar/GetEvents',

                dateClick: function (info) {
                    Swal.fire({
                        title: 'Date selected',
                        text: info.dateStr,
                        icon: 'info'
                    });
                },

                eventClick: function (info) {

                    const eventId = info.event.id;
                    const eventTitle = info.event.title;
                    const eventDate = info.event.startStr;

                    // Show event details first, then allow registration
                    showEventDetails(eventId, eventTitle, eventDate);
                }
            });

            calendar.render();

            // Helper functions defined outside calendar object
            async function showEventDetails(eventId, eventTitle, eventDate, cachedEventDetails = null) {
                try {
                    let eventDetails;
                    
                    if (cachedEventDetails) {
                        // Use cached data - no database call needed
                        eventDetails = cachedEventDetails;
                    } else {
                        // Fetch full event details from server (first time only)
                        const response = await fetch(`/Calendar/GetEventDetails?id=${eventId}`);
                        eventDetails = await response.json();
                    }

                    const eventImage = eventDetails.eventPhoto && eventDetails.eventPhoto.trim() !== '' 
                        ? `<img src="${eventDetails.eventPhoto}" alt="${eventDetails.name}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px;" />`
                        : '';

                    const eventEndTime = eventDetails.end 
                        ? `<p><strong>End:</strong> ${eventDetails.end}</p>`
                        : '';

                    Swal.fire({
                        title: eventDetails.name,
                        html: `
                            <div style="text-align: left; max-height: 60vh; overflow-y: auto; padding: 10px;">
                                ${eventImage}
                                <p><strong>Start:</strong> ${eventDetails.start}</p>
                                ${eventEndTime}
                                <div style="margin: 15px 0;">
                                    <strong>Details:</strong>
                                    <p style="margin-top: 8px; line-height: 1.5; color: #666;">
                                        ${eventDetails.details || 'No additional details available.'}
                                    </p>
                                </div>
                            </div>
                        `,
                        width: '600px',
                        showCancelButton: true,
                        confirmButtonText: 'Register for Event',
                        cancelButtonText: 'Close',
                        confirmButtonColor: '#28a745',
                        focusConfirm: false,
                        allowOutsideClick: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Get user role and proceed to registration, pass cached data
                            const userRole = '@ViewBag.UserRole';
                            showRegistrationForm(eventId, eventTitle, eventDate, userRole, eventDetails);
                        }
                    });
                } catch (error) {
                    console.error('Error fetching event details:', error);
                    Swal.fire('Error', 'Could not load event details', 'error');
                }
            }

            function showRegistrationForm(eventId, eventTitle, eventDate, role, cachedEventDetails = null) {
                    // Normalize role to have first letter capitalized
                    role = role.charAt(0).toUpperCase() + role.slice(1).toLowerCase();
                    
                    // Step 2: Show registration form based on role
                    const volunteerFields = role === 'Volunteer' ? `
                        <div class="form-group text-left mt-2">
                            <label>Preferred Role/Task</label>
                            <textarea id="PreferredRole" class="form-control" rows="2" placeholder="e.g., Setup, Registration desk, Cleanup, Photography"></textarea>
                        </div>
                        <div class="form-group text-left mt-2">
                            <label>Skills/Experience</label>
                            <textarea id="Skills" class="form-control" rows="2" placeholder="e.g., Event management, First aid"></textarea>
                        </div>
                    ` : '';

                    const participantFields = role === 'Participant' ? `
                        <div class="form-group text-left mt-2">
                            <label>Dietary Requirements</label>
                            <textarea id="DietaryRequirements" class="form-control" rows="2" placeholder="e.g., Vegetarian, Allergies"></textarea>
                        </div>
                        <div class="form-group text-left mt-2">
                            <label>Emergency Contact</label>
                            <input type="text" id="EmergencyContact" class="form-control" placeholder="Name and phone number" />
                        </div>
                    ` : '';

                    const roleInfo = role === 'Volunteer' 
                        ? '<p class="text-success">Thank you for volunteering! Registration is free.</p>'
                        : '<p class="text-info">Registration fee: $50.00</p>';

                    Swal.fire({
                        title: `Register as ${role}`,
                        html: `
                            <div style="max-height: 60vh; overflow-y: auto; padding: 10px;">
                                ${roleInfo}
                                <form id="registerForm">
                                    <input type="hidden" id="EventId" value="${eventId}" />
                                    <input type="hidden" id="Role" value="${role}" />

                                    <div class="form-group text-left">
                                        <label>Event</label>
                                        <input class="form-control" value="${eventTitle}" readonly />
                                    </div>

                                    <div class="form-group text-left mt-2">
                                        <label>Date</label>
                                        <input class="form-control" value="${eventDate}" readonly />
                                    </div>

                                    <div class="form-group text-left mt-2">
                                        <label>Full Name *</label>
                                        <input type="text" id="FullName" class="form-control" required />
                                        <small class="text-danger" id="nameError" style="display:none;">Please enter your full name</small>
                                    </div>

                                    <div class="form-group text-left mt-2">
                                        <label>Email *</label>
                                        <input type="email" id="Email" class="form-control" required />
                                        <small class="text-danger" id="emailError" style="display:none;">Please enter a valid email address</small>
                                    </div>

                                    <div class="form-group text-left mt-2">
                                        <label>Phone Number</label>
                                        <input type="tel" id="PhoneNumber" class="form-control" 
                                               placeholder="12345678" maxlength="8" />
                                        <small class="text-muted">Optional: 8 digits</small>
                                        <small class="text-danger" id="phoneError" style="display:none;">Please enter exactly 8 digits only</small>
                                    </div>

                                    ${volunteerFields}
                                    ${participantFields}
                                </form>
                            </div>
                        `,
                        width: '600px',
                        showCancelButton: true,
                        confirmButtonText: 'Submit Registration',
                        cancelButtonText: 'Back',
                        focusConfirm: false,
                        allowOutsideClick: false,
                        didOpen: () => {
                            // Add real-time validation
                            const emailInput = document.getElementById('Email');
                            const emailError = document.getElementById('emailError');
                            const nameInput = document.getElementById('FullName');
                            const nameError = document.getElementById('nameError');
                            const phoneInput = document.getElementById('PhoneNumber');
                            const phoneError = document.getElementById('phoneError');

                            emailInput.addEventListener('blur', function() {
                                // Simple email validation - just check for @@ and .
                                if (this.value && (!this.value.includes('@@') || !this.value.includes('.'))) {
                                    emailError.style.display = 'block';
                                    this.classList.add('is-invalid');
                                } else {
                                    emailError.style.display = 'none';
                                    this.classList.remove('is-invalid');
                                }
                            });

                            nameInput.addEventListener('blur', function() {
                                if (!this.value.trim()) {
                                    nameError.style.display = 'block';
                                    this.classList.add('is-invalid');
                                } else {
                                    nameError.style.display = 'none';
                                    this.classList.remove('is-invalid');
                                }
                            });

                            phoneInput.addEventListener('blur', function() {
                                // Phone validation: exactly 8 digits (numbers only)
                                const phoneRegex = /^\d{8}$/;
                                if (this.value && !phoneRegex.test(this.value)) {
                                    phoneError.style.display = 'block';
                                    this.classList.add('is-invalid');
                                } else {
                                    phoneError.style.display = 'none';
                                    this.classList.remove('is-invalid');
                                }
                            });
                        },
                        preConfirm: () => {
                            const fullName = document.getElementById('FullName').value.trim();
                            const email = document.getElementById('Email').value.trim();
                            const phoneNumber = document.getElementById('PhoneNumber').value.trim();

                            // Validate full name
                            if (!fullName) {
                                Swal.showValidationMessage('Please enter your full name');
                                return false;
                            }

                            // Validate email format - simple check
                            if (!email || !email.includes('@@') || !email.includes('.')) {
                                Swal.showValidationMessage('Please enter a valid email address (e.g., name@@example.com)');
                                return false;
                            }

                            // Validate phone number if provided - exactly 8 digits (numbers only)
                            const phoneRegex = /^\d{8}$/;
                            if (phoneNumber && !phoneRegex.test(phoneNumber)) {
                                Swal.showValidationMessage('Please enter a valid phone number (8 digits only)');
                                return false;
                            }

                            return {
                                eventId: eventId,
                                eventName: eventTitle,
                                role: role,
                                fullName: fullName,
                                email: email,
                                phoneNumber: phoneNumber,
                                preferredRole: role === 'Volunteer' ? document.getElementById('PreferredRole').value : null,
                                skills: role === 'Volunteer' ? document.getElementById('Skills').value : null,
                                dietaryRequirements: role === 'Participant' ? document.getElementById('DietaryRequirements').value : null,
                                emergencyContact: role === 'Participant' ? document.getElementById('EmergencyContact').value : null
                            };
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            submitRegistration(result.value);
                        } else if (result.dismiss === Swal.DismissReason.cancel) {
                            // Back button clicked - return to event details with cached data (no delay!)
                            showEventDetails(eventId, eventTitle, eventDate, cachedEventDetails);
                        }
                    });
                }

                function submitRegistration(registrationData) {
                    // Step 3: Submit registration
                    fetch('/Calendar/Register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken':
                                document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify(registrationData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.requiresPayment) {
                                // Step 4: Show payment for participants
                                showPaymentModal(data.registrationId, data.qrCode, data.paymentAmount);
                            } else {
                                // Volunteer - no payment needed
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Registration Successful!',
                                    html: `
                                        <p>Your registration has been confirmed.</p>
                                        <p><strong>Registration ID:</strong> ${data.registrationId}</p>
                                        <p><strong>QR Code:</strong> ${data.qrCode}</p>
                                    `
                                });
                            }
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(() => {
                        Swal.fire('Error', 'Something went wrong', 'error');
                    });
                }

                function showPaymentModal(registrationId, qrCode, amount) {
                    // Step 4: Show mock QR code for payment
                    Swal.fire({
                        title: 'Payment Required',
                        html: `
                            <h5>Scan QR Code to Pay</h5>
                            <div style="background: #f0f0f0; padding: 20px; margin: 20px 0; border-radius: 8px;">
                                <div style="background: #000; color: #fff; padding: 30px; font-family: monospace; font-size: 14px; word-break: break-all;">
                                    ${qrCode}
                                </div>
                            </div>
                            <p><strong>Amount: $${amount.toFixed(2)}</strong></p>
                            <p class="text-muted small">This is a mock QR code for prototype purposes</p>
                        `,
                        showCancelButton: false,
                        confirmButtonText: "I've Completed Payment",
                        allowOutsideClick: false
                    }).then((result) => {
                        if (result.isConfirmed) {
                            confirmPayment(registrationId, qrCode);
                        }
                    });
                }

                function confirmPayment(registrationId, qrCode) {
                    // Step 5: Confirm payment and update database
                    fetch('/Calendar/ConfirmPayment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken':
                                document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify({
                            registrationId: registrationId,
                            qrCode: qrCode
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Payment Confirmed!',
                                html: `
                                    <p>Your registration and payment have been confirmed.</p>
                                    <p><strong>Registration ID:</strong> ${data.registration.id}</p>
                                    <p><strong>QR Code:</strong> ${data.registration.qrCode}</p>
                                `
                            });
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(() => {
                        Swal.fire('Error', 'Payment confirmation failed', 'error');
                    });
                }
        });
    </script>

    @* Optional success popup *@
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <script>
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: '@successMessage'
            });
        </script>
    }
}
