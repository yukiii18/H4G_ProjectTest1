@{
    ViewData["Title"] = "QR Scanner";
    Layout = "~/Views/Shared/_Member.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="text-center mb-5">
        <div class="mb-3">
            <div class="qr-icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                </svg>
            </div>
        </div>
        <h2 class="fw-bold mb-2">Mark Your Attendance</h2>
        <p class="text-muted mb-0">Scan the QR code or upload an image to check in</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <!-- Scanner Card -->
            <div class="card shadow-sm border-0 mb-4 scanner-card">
                <div class="card-header border-0 text-white d-flex align-items-center gap-2" style="background: linear-gradient(135deg, #56baed 0%, #3fa0d8 100%);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <h6 class="mb-0 fw-semibold">Camera Scanner</h6>
                </div>
                <div class="card-body p-4">
                    <div id="qr-reader" class="rounded-3 overflow-hidden"></div>
                </div>
            </div>

            <!-- Upload Option -->
            <div class="card shadow-sm border-0 mb-4 upload-card">
                <div class="card-header border-0 text-white d-flex align-items-center gap-2" style="background: linear-gradient(135deg, #5fcde4 0%, #4ab3c6 100%);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <h6 class="mb-0 fw-semibold">Upload QR Image</h6>
                </div>
                <div class="card-body p-4">
                    <div class="upload-zone text-center p-4 mb-3 rounded-3 border-2 border-dashed" id="upload-zone">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-muted mb-3">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <p class="text-muted mb-3">Click to select or drag and drop</p>
                        <input type="file" class="form-control" id="qr-file-input" accept="image/*">
                    </div>
                    <button class="btn btn-gradient w-100 py-2 fw-semibold" onclick="scanUploadedFile()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2" style="display: inline-block; vertical-align: middle;">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        Scan Image
                    </button>
                </div>
            </div>

            <!-- Result -->
            <div id="result" class="text-center mb-4"></div>

            <!-- Quick Tips -->
            <div class="tips-card">
                <div class="d-flex align-items-start gap-3">
                    <div class="tip-icon">ðŸ’¡</div>
                    <div>
                        <h6 class="fw-bold mb-2" style="color: #495057;">Quick Tips</h6>
                        <ul class="mb-0 small text-muted" style="line-height: 1.8;">
                            <li>Ensure good lighting for best camera results</li>
                            <li>Hold your device steady while scanning</li>
                            <li>The QR code should fill most of the scan area</li>
                            <li>Try uploading if camera scanning fails</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
    #qr-reader__dashboard_section_csr {
        display: none !important;
    }
    #qr-reader__dashboard_section {
        padding: 0 !important;
    }

    /* Icon wrapper */
    .qr-icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #56baed 0%, #3fa0d8 100%);
        border-radius: 20px;
        color: white;
        box-shadow: 0 8px 16px rgba(86, 186, 237, 0.4);
    }

    /* Cards */
    .scanner-card, .upload-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .scanner-card:hover, .upload-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-radius: 0.5rem 0.5rem 0 0 !important;
    }

    /* Upload zone */
    .upload-zone {
        background: #f8f9fa;
        border-color: #dee2e6 !important;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-zone:hover {
        background: #e9ecef;
        border-color: #adb5bd !important;
    }

    /* Gradient button */
    .btn-gradient {
        background: linear-gradient(135deg, #56baed 0%, #3fa0d8 100%);
        border: none;
        color: white;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-gradient:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(86, 186, 237, 0.5);
        color: white;
    }

    /* Tips card */
    .tips-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .tip-icon {
        font-size: 2rem;
        line-height: 1;
    }

    /* Result animations */
    .result-badge {
        display: inline-block;
        padding: 1rem 2rem;
        font-size: 1.05rem;
        border-radius: 12px;
        animation: slideDown 0.4s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @@media (max-width: 576px) {
        .qr-icon-wrapper {
            width: 60px;
            height: 60px;
        }

        .qr-icon-wrapper svg {
            width: 32px;
            height: 32px;
        }

        h2 {
            font-size: 1.5rem;
        }
    }
</style>

<script>
let isScanning = false;
let html5QrcodeScanner;

function onScanSuccess(decodedText) {
    if (isScanning) return;
    isScanning = true;

    console.log("QR scanned:", decodedText);

    // Pause the scanner while processing
    if (html5QrcodeScanner) {
        html5QrcodeScanner.pause(true);
    }

    const result = document.getElementById('result');
    result.innerHTML = '<div class="spinner-border" style="color: #56baed; width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Processing...</span></div>';

    fetch('/User/MarkAttendance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qrCode: decodedText })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            result.innerHTML = `
                <div class="alert alert-success result-badge border-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    ${data.message}
                </div>`;
            // Stop scanner on success
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
        } else {
            result.innerHTML = `
                <div class="alert alert-danger result-badge border-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    ${data.message}
                </div>`;
            // Resume scanner after showing error
            setTimeout(() => {
                isScanning = false;
                result.innerHTML = '';
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.resume();
                }
            }, 2500);
        }
    })
    .catch(error => {
        result.innerHTML = `
            <div class="alert alert-warning result-badge border-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Connection error. Please try again.
            </div>`;
        // Resume scanner after showing error
        setTimeout(() => {
            isScanning = false;
            result.innerHTML = '';
            if (html5QrcodeScanner) {
                html5QrcodeScanner.resume();
            }
        }, 2500);
    });
}

html5QrcodeScanner = new Html5QrcodeScanner(
    "qr-reader",
    {
        fps: 10,
        qrbox: 250,
        aspectRatio: 1.0
    },
    false
);
html5QrcodeScanner.render(onScanSuccess);

async function scanUploadedFile() {
    const fileInput = document.getElementById('qr-file-input');
    const file = fileInput.files[0];

    if (!file) {
        const result = document.getElementById('result');
        result.innerHTML = `
            <div class="alert alert-warning result-badge border-0">
                Please select an image file first
            </div>`;
        setTimeout(() => result.innerHTML = '', 2000);
        return;
    }

    const result = document.getElementById('result');
    result.innerHTML = '<div class="spinner-border" style="color: #56baed; width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Scanning...</span></div>';

    try {
        const html5QrCode = new Html5Qrcode("qr-reader");
        const decodedText = await html5QrCode.scanFile(file, true);
        onScanSuccess(decodedText);
    } catch (error) {
        result.innerHTML = `
            <div class="alert alert-danger result-badge border-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                Could not read QR code from image
            </div>`;
        setTimeout(() => result.innerHTML = '', 3000);
    }
}

// File input enhancement
document.getElementById('upload-zone').addEventListener('click', function() {
    document.getElementById('qr-file-input').click();
});

document.getElementById('qr-file-input').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        const fileName = e.target.files[0].name;
        document.querySelector('.upload-zone p').textContent = fileName;
    }
});
</script>