@model List<Application>

@{
    ViewData["Title"] = "Client Application Management";
    Layout = "~/Views/Shared/_Staff.cshtml";
}

@Html.AntiForgeryToken()

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-user-plus"></i> Client Applications</h2>
        <a href="@Url.Action("VolunteerRegistrations", "Application")" class="btn btn-success">
            <i class="fas fa-hands-helping"></i> View Volunteer Registrations
        </a>
    </div>

    <div class="mt-3">
        <div class="row">
            <div class="col-md-4">
                <label for="searchInput">Search:</label>
                <input type="text" id="searchInput" onkeyup="searchClientTable()" class="form-control" placeholder="Search by name, email, or notes...">
            </div>
            <div class="col-md-4">
                <label for="disabilityFilter">Filter by Disability Type:</label>
                <select id="disabilityFilter" onchange="filterClientTable()" class="form-control">
                    <option value="">-- All --</option>
                    <option value="intellectual">Intellectual Disability</option>
                    <option value="physical">Physical Disability</option>
                    <option value="developmental">Developmental Disability</option>
                    <option value="others">Others</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="clientStatusFilter">Filter by Status:</label>
                <select id="clientStatusFilter" onchange="filterClientTable()" class="form-control">
                    <option value="">-- All Statuses --</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="declined">Declined</option>
                </select>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <table class="table table-bordered table-striped" id="clientApplicationsTable">
            <thead class="thead-dark">
                <tr>
                    <th>Family Member Name</th>
                    <th>Disability Type</th>
                    <th>Caregiver Name</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model)
                {
                    <tr>
                        <td>@r.FamilyMemberName</td>
                        <td>@r.DisabilityType</td>
                        <td>@r.CaregiverName</td>
                        <td>
                            @{
                                string statusClass = r.Status switch
                                {
                                    "Approved" => "badge badge-success",
                                    "Declined" => "badge badge-danger",
                                    _ => "badge badge-warning"
                                };
                            }
                            <span class="@statusClass">@(r.Status ?? "Pending")</span>
                        </td>
                        <td>@r.Notes</td>
                        <td>
                            <a href="javascript:void(0);" class="text-primary"
                                onclick="showClientDetails('@r.Id', '@r.FamilyMemberName', '@r.DisabilityType', '@r.CaregiverName', '@r.Notes', '@r.Email', '@r.ContactNumber', '@r.Occupation', '@(r.Status ?? "Pending")')">
                                View Details
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Client Application Details Modal -->
<div class="modal fade" id="clientDetailsModal" tabindex="-1" role="dialog" aria-labelledby="clientDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientDetailsModalLabel">Client Application Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Family Member Name:</strong> <span id="clientDetailFamilyMember"></span></p>
                        <p><strong>Disability Type:</strong> <span id="clientDetailDisability"></span></p>
                        <p><strong>Caregiver Name:</strong> <span id="clientDetailCaregiver"></span></p>
                        <p><strong>Notes:</strong> <span id="clientDetailNotes"></span></p>
                        <p><strong>Email:</strong> <span id="clientDetailEmail"></span></p>
                        <p><strong>Contact Number:</strong> <span id="clientDetailContact"></span></p>
                        <p><strong>Occupation:</strong> <span id="clientDetailOccupation"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Medical Report</h6>
                        <iframe id="clientDetailMedicalReport" src="" width="100%" height="400px" style="border:1px solid #ccc;"></iframe>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="clientModalFooter">
                <button type="button" class="btn btn-success" id="clientApproveBtn" onclick="approveClientApplication()" style="display:none;">Approve</button>
                <button type="button" class="btn btn-danger" id="clientRejectBtn" onclick="rejectClientApplication()" style="display:none;">Decline</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Client Application Variables
        let currentApplicationId = '';
        let currentApplicantName = '';
        let currentApplicantEmail = '';

        // Client Application Functions
        function showClientDetails(applicationId, familyMember, disability, caregiver, notes, email, contact, occupation, status, medicalReportUrl) {
            currentApplicationId = applicationId;
            currentApplicantName = familyMember;
            currentApplicantEmail = email;

            document.getElementById("clientDetailFamilyMember").innerText = familyMember;
            document.getElementById("clientDetailDisability").innerText = disability;
            document.getElementById("clientDetailCaregiver").innerText = caregiver;
            document.getElementById("clientDetailNotes").innerText = notes;
            document.getElementById("clientDetailEmail").innerText = email;
            document.getElementById("clientDetailContact").innerText = contact;
            document.getElementById("clientDetailOccupation").innerText = occupation;

            document.getElementById("clientDetailMedicalReport").src = "/file/report123.pdf";

            const approveBtn = document.getElementById("clientApproveBtn");
            const rejectBtn = document.getElementById("clientRejectBtn");

            if (status === "Pending") {
                approveBtn.style.display = "inline-block";
                rejectBtn.style.display = "inline-block";
            } else {
                approveBtn.style.display = "none";
                rejectBtn.style.display = "none";
            }

            $('#clientDetailsModal').modal('show');
        }

        function approveClientApplication() {
            if (!currentApplicationId) {
                alert("Error: Application ID not found");
                return;
            }

            $('#clientDetailsModal').modal('hide');
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Application/ApproveApplication';
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'applicationId';
            idInput.value = currentApplicationId;
            form.appendChild(idInput);
            
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'applicantName';
            nameInput.value = currentApplicantName;
            form.appendChild(nameInput);
            
            const emailInput = document.createElement('input');
            emailInput.type = 'hidden';
            emailInput.name = 'applicantEmail';
            emailInput.value = currentApplicantEmail;
            form.appendChild(emailInput);
            
            document.body.appendChild(form);
            form.submit();
        }

        function rejectClientApplication() {
            if (!currentApplicationId) {
                alert("Error: Application ID not found");
                return;
            }

            $('#clientDetailsModal').modal('hide');
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Application/RejectApplication';
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'applicationId';
            idInput.value = currentApplicationId;
            form.appendChild(idInput);
            
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'applicantName';
            nameInput.value = currentApplicantName;
            form.appendChild(nameInput);
            
            document.body.appendChild(form);
            form.submit();
        }

        // Filter Functions
        function filterClientTable() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();
            const disabilityFilter = document.getElementById("disabilityFilter").value.toLowerCase();
            const statusFilter = document.getElementById("clientStatusFilter").value.toLowerCase();
            const table = document.getElementById("clientApplicationsTable");
            const rows = table.getElementsByTagName("tr");

            for (let i = 1; i < rows.length; i++) {
                const familyMemberCell = rows[i].getElementsByTagName("td")[0];
                const disabilityCell = rows[i].getElementsByTagName("td")[1];
                const caregiverCell = rows[i].getElementsByTagName("td")[2];
                const statusCell = rows[i].getElementsByTagName("td")[3];
                const notesCell = rows[i].getElementsByTagName("td")[4];
                
                if (familyMemberCell && disabilityCell && caregiverCell && statusCell && notesCell) {
                    const familyMemberText = familyMemberCell.textContent || familyMemberCell.innerText;
                    const disabilityText = disabilityCell.textContent || disabilityCell.innerText;
                    const caregiverText = caregiverCell.textContent || caregiverCell.innerText;
                    const statusText = statusCell.textContent || statusCell.innerText;
                    const notesText = notesCell.textContent || notesCell.innerText;
                    
                    // Search across multiple fields
                    const searchMatch = searchInput === "" || 
                        familyMemberText.toLowerCase().includes(searchInput) ||
                        caregiverText.toLowerCase().includes(searchInput) ||
                        notesText.toLowerCase().includes(searchInput);
                    
                    const disabilityMatch = disabilityFilter === "" || disabilityText.toLowerCase().includes(disabilityFilter);
                    const statusMatch = statusFilter === "" || statusText.toLowerCase().includes(statusFilter);
                    
                    if (searchMatch && disabilityMatch && statusMatch) {
                        rows[i].style.display = "";
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }
        }

        function searchClientTable() {
            filterClientTable(); // Reuse the existing filter logic
        }
    </script>
}