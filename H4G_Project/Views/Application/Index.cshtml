@model List<Application>

@{
    ViewData["Title"] = "Application Forms";
    Layout = "~/Views/Shared/_Staff.cshtml";
}

@Html.AntiForgeryToken()

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<div class="mt-3">
    <label for="disabilityFilter">Filter by Disability Type:</label>
    <select id="disabilityFilter" onchange="filterTable()" class="form-control w-25 d-inline-block">
        <option value="">-- All --</option>
        <option value="intellectual">Intellectual Disability</option>
        <option value="physical">Physical Disability</option>
        <option value="developmental">Developmental Disability</option>
        <option value="others">Others</option>
    </select>
</div>

<div class="container mt-4">
    <table class="table table-bordered table-striped" id="firebaseTable">
        <thead class="thead-dark">
            <tr>
                <th>Family Member Name</th>
                <th>Disability Type</th>
                <th>Caregiver Name</th>
                <th>Status</th>
                <th>Notes</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in Model)
            {
                <tr>
                    <td>@r.FamilyMemberName</td>
                    <td>@r.DisabilityType</td>
                    <td>@r.CaregiverName</td>
                    <td>
                        @{
                            string statusClass = r.Status switch
                            {
                                "Approved" => "badge badge-success",
                                "Declined" => "badge badge-danger",
                                _ => "badge badge-warning"
                            };
                        }
                        <span class="@statusClass">@(r.Status ?? "Pending")</span>
                    </td>
                    <td>@r.Notes</td>
                    <td>
                        <!-- Hyperlink that triggers modal -->
                        <a href="javascript:void(0);" class="text-primary"
                            onclick="showDetails('@r.Id', '@r.FamilyMemberName', '@r.DisabilityType', '@r.CaregiverName', '@r.Notes', '@r.Email', '@r.ContactNumber', '@r.Occupation', '@(r.Status ?? "Pending")')">
                            View Details
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Application Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="row">
                    <!-- Left column: application details -->
                    <div class="col-md-6">
                        <p><strong>Family Member Name:</strong> <span id="detailFamilyMember"></span></p>
                        <p><strong>Disability Type:</strong> <span id="detailDisability"></span></p>
                        <p><strong>Caregiver Name:</strong> <span id="detailCaregiver"></span></p>
                        <p><strong>Notes:</strong> <span id="detailNotes"></span></p>
                        <p><strong>Email:</strong> <span id="detailEmail"></span></p>
                        <p><strong>Contact Number:</strong> <span id="detailContact"></span></p>
                        <p><strong>Occupation:</strong> <span id="detailOccupation"></span></p>
                    </div>

                    <!-- Right column: embedded medical report -->
                    <div class="col-md-6">
                        <h6>Medical Report</h6>
                        <iframe id="detailMedicalReport" src="" width="100%" height="400px"
                            style="border:1px solid #ccc;"></iframe>
                    </div>
                </div>
            </div>

            <div class="modal-footer" id="modalFooter">
                <!-- Buttons will be dynamically updated based on status -->
                <button type="button" class="btn btn-success" id="approveBtn" onclick="approveApplication()" style="display:none;">Approve</button>
                <button type="button" class="btn btn-danger" id="rejectBtn" onclick="rejectApplication()" style="display:none;">Decline</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentApplicationId = '';
        let currentApplicantName = '';
        let currentApplicantEmail = '';

        function showDetails(applicationId, familyMember, disability, caregiver, notes, email, contact, occupation, status, medicalReportUrl) {
            // Store current application data
            currentApplicationId = applicationId;
            currentApplicantName = familyMember;
            currentApplicantEmail = email;

            // Populate modal fields
            document.getElementById("detailFamilyMember").innerText = familyMember;
            document.getElementById("detailDisability").innerText = disability;
            document.getElementById("detailCaregiver").innerText = caregiver;
            document.getElementById("detailNotes").innerText = notes;
            document.getElementById("detailEmail").innerText = email;
            document.getElementById("detailContact").innerText = contact;
            document.getElementById("detailOccupation").innerText = occupation;

            // Hardcode at the moment, will need to change
            document.getElementById("detailMedicalReport").src = "/file/report123.pdf";
            //document.getElementById("detailMedicalReport").src = medicalReportUrl;

            // Show/hide buttons based on status
            const approveBtn = document.getElementById("approveBtn");
            const rejectBtn = document.getElementById("rejectBtn");

            if (status === "Pending") {
                approveBtn.style.display = "inline-block";
                rejectBtn.style.display = "inline-block";
            } else {
                approveBtn.style.display = "none";
                rejectBtn.style.display = "none";
            }

            $('#detailsModal').modal('show');
        }

        function approveApplication() {
            if (!currentApplicationId) {
                alert("Error: Application ID not found");
                return;
            }

            // Close the modal first
            $('#detailsModal').modal('hide');
            
            // Create a form and submit it to the ApproveApplication action
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Application/ApproveApplication';
            
            // Add CSRF token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }
            
            // Add application data
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'applicationId';
            idInput.value = currentApplicationId;
            form.appendChild(idInput);
            
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'applicantName';
            nameInput.value = currentApplicantName;
            form.appendChild(nameInput);
            
            const emailInput = document.createElement('input');
            emailInput.type = 'hidden';
            emailInput.name = 'applicantEmail';
            emailInput.value = currentApplicantEmail;
            form.appendChild(emailInput);
            
            document.body.appendChild(form);
            form.submit();
        }

        function rejectApplication() {
            if (!currentApplicationId) {
                alert("Error: Application ID not found");
                return;
            }

            if (confirm("Are you sure you want to decline this application for " + currentApplicantName + "?")) {
                // Create a form and submit it to the RejectApplication action
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/Application/RejectApplication';
                
                // Add CSRF token
                const token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = token.value;
                    form.appendChild(tokenInput);
                }
                
                // Add application data
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = 'applicationId';
                idInput.value = currentApplicationId;
                form.appendChild(idInput);
                
                const nameInput = document.createElement('input');
                nameInput.type = 'hidden';
                nameInput.name = 'applicantName';
                nameInput.value = currentApplicantName;
                form.appendChild(nameInput);
                
                document.body.appendChild(form);
                form.submit();
            }
            
            $('#detailsModal').modal('hide');
        }
    </script>
}